<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Snow Globe NFT</title>
<style>
  body {
    margin: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    background: #000;
    height: 100vh;
  }
  #globeWrapper {
    position: relative;
    width: 90vw;
    max-width: 500px;
    aspect-ratio: 1 / 1;
    border-radius: 50%;
    overflow: hidden;
    border: 10px solid rgba(255,255,255,0.4);
    box-shadow: 0 0 40px rgba(255,255,255,0.3) inset;
  }
  canvas {
    width: 100%;
    height: 100%;
    display: block;
  }
</style>
</head>
<body>
<div id="globeWrapper">
  <canvas id="globeCanvas"></canvas>
</div>

<script>
const PARTICLE_COUNT = 400;
const SHAKE_FORCE = 2.5;
const SWIPE_FORCE = 3.0;
const GRAVITY = 0.05;

let canvas = document.getElementById("globeCanvas");
let ctx = canvas.getContext("2d");
let W, H, globeRadius;

// -------------------
// Background
// -------------------
let background = new Image();
background.src = "https://ipfs.io/ipfs/bafybeiepec62olvujw52tbntuaryuyoiofjjz7s246hmethykvgfbnls34";

// -------------------
// Snow Object
// -------------------
let snowImg = new Image();
snowImg.src = "https://ipfs.io/ipfs/bafybeigftb6innx7vd42qicjuhntoxlegfup2rpqu3flruilqinnvw2nae";

class SnowObject {
    constructor(img){
        this.img = img;
        this.width = this.img.width * 0.25;
        this.height = this.img.height * 0.25;
        this.reset();
    }
    reset(){
        this.x = W/2;
        this.y = H/2 - globeRadius*0.3; // start slightly above center
        this.vx = 0; this.vy = 0;
        this.settled=false;
        this.angle = 0;
        this.angularVelocity = (Math.random()-0.5)*0.02;
        // scale to current canvas size
        let scale = 0.25*(W/500);
        this.width = this.img.width * scale;
        this.height = this.img.height * scale;
    }
    applyForce(fx, fy){
        this.vx += fx;
        this.vy += fy;
        this.settled = false;
    }
    update(){
        if(!this.settled){
            this.vy += GRAVITY*1.5; // heavier
            this.x += this.vx;
            this.y += this.vy;
            this.vx *= 0.98;
            this.vy *= 0.98;
            this.angle += this.angularVelocity;
        }
        // globe boundary collision
        let dx = this.x - W/2;
        let dy = this.y - H/2;
        let dist = Math.sqrt(dx*dx + dy*dy);
        let maxR = globeRadius - Math.max(this.width,this.height)/2;
        if(dist > maxR){
            let angle = Math.atan2(dy, dx);
            this.x = W/2 + Math.cos(angle)*maxR;
            this.y = H/2 + Math.sin(angle)*maxR;
            this.vx *= -0.5;
            this.vy *= -0.5;
            if(Math.abs(this.vx)<0.01 && Math.abs(this.vy)<0.01) this.settled=true;
        }
    }
    draw(){
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.rotate(this.angle);
        ctx.drawImage(this.img,-this.width/2,-this.height/2,this.width,this.height);
        ctx.restore();
    }
}

let snowObject;

// -------------------
// Particle System
// -------------------
class Particle {
    constructor(){
        this.reset();
    }
    reset(){
        let angle = Math.random()*Math.PI*2;
        let r = Math.random()*globeRadius*0.9;
        this.x = W/2 + r*Math.cos(angle);
        this.y = H/2 + r*Math.sin(angle);
        this.vx = 0; this.vy = 0;
        this.size = Math.random()*2+1;
        this.settled=false;
    }
    applyForce(fx, fy){ this.vx+=fx; this.vy+=fy; this.settled=false; }
    update(){
        if(!this.settled){
            this.vy += GRAVITY;
            this.x += this.vx; this.y += this.vy;
            this.vx *=0.98; this.vy*=0.98;
        }
        let dx = this.x - W/2;
        let dy = this.y - H/2;
        let dist = Math.sqrt(dx*dx + dy*dy);
        if(dist > globeRadius){
            let angle = Math.atan2(dy, dx);
            this.x = W/2 + Math.cos(angle)*globeRadius;
            this.y = H/2 + Math.sin(angle)*globeRadius;
            this.vx*=-0.5; this.vy*=-0.5;
            if(Math.abs(this.vx)<0.01 && Math.abs(this.vy)<0.01) this.settled=true;
        }
    }
    draw(){
        ctx.fillStyle="white";
        ctx.beginPath();
        ctx.arc(this.x,this.y,this.size,0,Math.PI*2);
        ctx.fill();
    }
}

let particles = [];
for(let i=0;i<PARTICLE_COUNT;i++) particles.push(new Particle());

// -------------------
// Swipe Detection
// -------------------
let lastX=null, swipeEnergy=0;
canvas.addEventListener("touchmove", e=>{
    let touch = e.touches[0];
    if(lastX!==null){
        let dx = touch.clientX-lastX;
        swipeEnergy+=Math.abs(dx)*0.01;
        if(swipeEnergy>1) triggerSwirl(SWIPE_FORCE);
    }
    lastX=touch.clientX;
});
canvas.addEventListener("touchend",()=>{ lastX=null; swipeEnergy=0; });

// -------------------
// Accelerometer
// -------------------
if(window.DeviceMotionEvent){
    window.addEventListener("devicemotion", e=>{
        let shake=Math.abs(e.acceleration.x)+Math.abs(e.acceleration.y)+Math.abs(e.acceleration.z);
        if(shake>22) triggerSwirl(SHAKE_FORCE);
    });
}

// -------------------
// Swirl
// -------------------
function triggerSwirl(force){
    particles.forEach(p=>{
        let angle=Math.random()*Math.PI*2;
        p.vx+=Math.cos(angle)*force;
        p.vy+=Math.sin(angle)*force;
        p.settled=false;
    });
    if(snowObject) {
        let angle=Math.random()*Math.PI*2;
        snowObject.applyForce(Math.cos(angle)*force, Math.sin(angle)*force);
    }
}

// -------------------
// Animation Loop
// -------------------
function loop(){
    ctx.clearRect(0,0,W,H);
    if(background.complete) ctx.drawImage(background,0,0,W,H);
    if(snowObject) { snowObject.update(); snowObject.draw(); }
    particles.forEach(p=>{ p.update(); p.draw(); });
    requestAnimationFrame(loop);
}

// -------------------
// Resize Canvas
// -------------------
function resizeCanvas(){
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    W = canvas.width; H = canvas.height;
    globeRadius = W/2 - 10;

    if(snowObject){
        snowObject.reset();
    }
    particles.forEach(p=>p.reset());
}
window.addEventListener('resize', resizeCanvas);

// -------------------
// Start after images loaded
// -------------------
function startIfReady(){
    if(background.complete && snowImg.complete){
        resizeCanvas();
        snowObject = new SnowObject(snowImg);
        loop();
    } else {
        setTimeout(startIfReady,50);
    }
}
startIfReady();
</script>
</body>
</html>
