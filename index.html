<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
<title>Snow Globe — Fixed Rotation + Glass Effects</title>

<style>
  html,body{
    margin:0; padding:0; background:#060b18;
    display:flex; justify-content:center; align-items:center;
    height:100%; overflow:hidden;
  }
  #globeWrapper{
    width:88vw; max-width:520px; aspect-ratio:1/1;
    border-radius:50%; overflow:hidden;
    border:10px solid rgba(255,255,255,0.12);
    box-shadow:
      0 0 60px rgba(0,0,0,0.7) inset,
      0 0 20px rgba(50,100,255,0.4);
  }
  canvas{ width:100%; height:100%; display:block; }
</style>
</head>

<body>
<div id="globeWrapper">
  <canvas id="globeCanvas"></canvas>
</div>

<script>
/* -----------------------------------------------------------
      Snow Globe — CORRECTED ROTATION + COLLISION + GLARE
----------------------------------------------------------- */

const BG_CID  = "bafybeiepec62olvujw52tbntuaryuyoiofjjz7s246hmethykvgfbnls34";
const OBJ_CID = "bafybeihnyoiyxsrzicx23funhiiwijfl55twsls6bsn4ypc2ybxyh7ucc4";

const PARTICLE_COUNT = 400;
const OBJ_GRAVITY = 0.17;
const OBJ_DAMP = 0.95;

let W=0,H=0, globeRadius=0;
let center={x:0,y:0};

const canvas=document.getElementById("globeCanvas");
const ctx=canvas.getContext("2d");

// ----------------------------------------
// Responsive resize
// ----------------------------------------
function resize(){
  const w=canvas.parentElement.clientWidth;
  const h=canvas.parentElement.clientHeight;
  const dpr=Math.min(window.devicePixelRatio||1,2);

  canvas.width = w*dpr;
  canvas.height= h*dpr;
  canvas.style.width=w+"px";
  canvas.style.height=h+"px";

  ctx.setTransform(dpr,0,0,dpr,0,0);

  W=w; H=h;
  center.x=W/2;
  center.y=H/2;
  globeRadius=Math.min(W,H)/2 - 8;
}
resize();
addEventListener("resize",resize);


// ----------------------------------------
// Load images
// ----------------------------------------
const bgImg = new Image();
bgImg.src = "https://ipfs.io/ipfs/"+BG_CID;

const objImg = new Image();
objImg.src = "https://ipfs.io/ipfs/"+OBJ_CID;


// ----------------------------------------
// Particle system
// ----------------------------------------
class Particle{
  constructor(){ this.reset(); }

  reset(){
    const ang=Math.random()*Math.PI*2;
    const r=Math.sqrt(Math.random())*(globeRadius*0.9);

    this.x=center.x+Math.cos(ang)*r;
    this.y=center.y+Math.sin(ang)*r;

    this.vx=(Math.random()-.5)*0.4;
    this.vy=(Math.random()-.5)*0.4;
    this.size=1+Math.random()*2;
    this.alpha=0.5+Math.random()*0.4;
  }

  update(dt){
    this.vy+=0.045*dt*60;
    this.x+=this.vx*dt*60;
    this.y+=this.vy*dt*60;

    const dx=this.x-center.x;
    const dy=this.y-center.y;
    const d=Math.hypot(dx,dy);

    if(d>globeRadius-2){
      const nx=dx/d, ny=dy/d;
      this.x=center.x+nx*(globeRadius-2);
      this.y=center.y+ny*(globeRadius-2);

      const dot=this.vx*nx+this.vy*ny;
      this.vx -= 1.5 * dot * nx;
      this.vy -= 1.5 * dot * ny;

      this.vx*=0.88; 
      this.vy*=0.88;
    }
  }

  draw(){
    ctx.globalAlpha=this.alpha;
    ctx.beginPath();
    ctx.arc(this.x,this.y,this.size,0,Math.PI*2);
    ctx.fillStyle="#fff";
    ctx.fill();
    ctx.globalAlpha=1;
  }
}


// ----------------------------------------
// Snow Object — Circular physics
// ----------------------------------------
class SnowObj{
  constructor(img){
    this.img=img;

    this.scale = 0.25 * (Math.min(W,H)/500);
    this.w = img.width * this.scale;
    this.h = img.height * this.scale;

    // treat object as circle for physics
    this.r = Math.max(this.w,this.h)/2;

    this.x=center.x;
    this.y=center.y - globeRadius*0.4;
    this.vx=0; this.vy=0;

    this.angle=0;
    this.angularVelocity=0;
  }

  applyForce(fx,fy){
    this.vx += fx;
    this.vy += fy;
    this.angularVelocity += (Math.random()-.5)*0.03;
  }

  update(dt){
    this.vy += OBJ_GRAVITY * dt*60;
    this.x  += this.vx * dt*60;
    this.y  += this.vy * dt*60;

    this.angle += this.angularVelocity*dt*60;

    // stop tiny drifting
    if (Math.abs(this.angularVelocity) < 0.002)
        this.angularVelocity = 0;

    this.vx*=OBJ_DAMP;
    this.vy*=OBJ_DAMP;
    this.angularVelocity *= 0.96;

    const dx=this.x-center.x;
    const dy=this.y-center.y;
    const d=Math.hypot(dx,dy);
    const maxD = globeRadius - this.r;

    if(d > maxD){
      const nx=dx/d, ny=dy/d;
      const overlap = d - maxD;

      this.x -= nx * overlap;
      this.y -= ny * overlap;

      const dot = this.vx*nx + this.vy*ny;
      this.vx -= (1.0+0.3) * dot * nx;
      this.vy -= (1.0+0.3) * dot * ny;

      // allow sliding
      const tx=-ny, ty=nx;
      const tdot=this.vx*tx + this.vy*ty;
      this.vx = tdot*tx + this.vx*0.85;
      this.vy = tdot*ty + this.vy*0.85;

      // subtle rotation on collisions
      this.angularVelocity += (tdot>0?1:-1)*0.012;
    }
  }

  draw(){
    ctx.save();
    ctx.translate(this.x,this.y);
    ctx.rotate(this.angle);
    ctx.drawImage(this.img,-this.w/2, -this.h/2, this.w, this.h);
    ctx.restore();
  }
}


// ----------------------------------------
// Init + Animation Loop
// ----------------------------------------
let particles=[];
let obj=null;
let last=performance.now();

function start(){
  particles=[];
  for(let i=0;i<PARTICLE_COUNT;i++) particles.push(new Particle());
  obj=new SnowObj(objImg);
  requestAnimationFrame(loop);
}

bgImg.onload = ()=>{ if(objImg.complete) start(); };
objImg.onload = ()=>{ if(bgImg.complete) start(); };


// ----------------------------------------
// Shake Detection
// ----------------------------------------
window.addEventListener("devicemotion", e=>{
  const m = Math.abs(e.acceleration.x) + Math.abs(e.acceleration.y);
  if(m>18){
    swirl();
  }
});

canvas.addEventListener("touchmove", e=>{
  swirl();
});

function swirl(){
  particles.forEach(p=>{
    const ang=Math.random()*Math.PI*2;
    p.vx += Math.cos(ang)*2.5;
    p.vy += Math.sin(ang)*2.5;
  });
  obj.applyForce((Math.random()-.5)*4,(Math.random()-.5)*4);
}


// ----------------------------------------
// Main Loop
// ----------------------------------------
function loop(t){
  const dt=Math.min(.033,(t-last)/1000);
  last=t;

  ctx.clearRect(0,0,W,H);

  // Clip to globe
  ctx.save();
  ctx.beginPath();
  ctx.arc(center.x,center.y,globeRadius,0,Math.PI*2);
  ctx.clip();

  // BG
  ctx.drawImage(bgImg,0,0,W,H);

  // Object
  obj.update(dt);
  obj.draw();

  // Particles
  for(const p of particles){ p.update(dt); p.draw(); }

  // --- Glass Glare ---
  ctx.save();
  ctx.globalAlpha=0.22;
  const grad = ctx.createRadialGradient(
    center.x - globeRadius*0.35,
    center.y - globeRadius*0.45,
    5,
    center.x, center.y, globeRadius*1.2
  );
  grad.addColorStop(0,"rgba(255,255,255,0.5)");
  grad.addColorStop(1,"rgba(255,255,255,0)");
  ctx.fillStyle=grad;
  ctx.beginPath();
  ctx.arc(center.x,center.y,globeRadius,0,Math.PI*2);
  ctx.fill();
  ctx.restore();

  // Chromatic rim
  ctx.save();
  ctx.lineWidth=4;
  ctx.strokeStyle="rgba(120,150,255,0.32)";
  ctx.beginPath();
  ctx.arc(center.x,center.y,globeRadius-2,0,Math.PI*2);
  ctx.stroke();
  ctx.restore();

  ctx.restore();

  requestAnimationFrame(loop);
}

</script>
</body>
</html>
