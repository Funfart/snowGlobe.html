<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
<title>Snow Globe — Fixed Rotation + Glare</title>
<style>
  html,body{
    margin:0; padding:0; background:#060b18;
    display:flex; justify-content:center; align-items:center; height:100%;
  }
  #globeWrapper{
    width:88vw; max-width:520px; aspect-ratio:1/1;
    border-radius:50%; overflow:hidden;
    border:10px solid rgba(255,255,255,0.15);
    box-shadow:0 20px 50px rgba(0,0,0,0.6) inset;
  }
  canvas{ width:100%; height:100%; display:block; }
</style>
</head>
<body>
<div id="globeWrapper">
  <canvas id="globeCanvas"></canvas>
</div>

<script>
/* ======================================================
   Snow Globe — Circular Physics + FIXED ROTATION + GLARE
   ====================================================== */

const BG_CID = "bafybeiepec62olvujw52tbntuaryuyoiofjjz7s246hmethykvgfbnls34";
const OBJ_CID = "bafybeigftb6innx7vd42qicjuhntoxlegfup2rpqu3flruilqinnvw2nae";

const PARTICLE_COUNT = 400;
const OBJ_GRAVITY = 0.16;
const OBJ_DAMP = 0.96;

let W=0,H=0;
let globeRadius=0;
let center={x:0,y:0};

const canvas=document.getElementById("globeCanvas");
const ctx=canvas.getContext("2d");

function resize(){
  const w=canvas.parentElement.clientWidth;
  const h=canvas.parentElement.clientHeight;
  const dpr=Math.min(window.devicePixelRatio||1,2);

  canvas.width=w*dpr;
  canvas.height=h*dpr;
  canvas.style.width=w+"px";
  canvas.style.height=h+"px";
  ctx.setTransform(dpr,0,0,dpr,0,0);

  W=w; H=h;
  center.x=W/2; center.y=H/2;
  globeRadius=Math.min(W,H)/2 - 8;
}
resize();
window.addEventListener("resize",resize);


// ---------------- IMAGES ----------------
const bgImg=new Image();
bgImg.src="https://ipfs.io/ipfs/"+BG_CID;

const objImg=new Image();
objImg.src="https://ipfs.io/ipfs/"+OBJ_CID;


// ---------------- PARTICLES ----------------
class Particle{
  constructor(){
    this.reset();
  }
  reset(){
    const ang=Math.random()*Math.PI*2;
    const r=Math.sqrt(Math.random())*(globeRadius*0.9);
    this.x=center.x+Math.cos(ang)*r;
    this.y=center.y+Math.sin(ang)*r;
    this.vx=(Math.random()-.5)*0.3;
    this.vy=(Math.random()-.5)*0.3;
    this.size=1+Math.random()*2;
    this.alpha=0.5+Math.random()*0.5;
  }
  update(dt){
    this.vy+=0.04*dt*60;
    this.x+=this.vx*dt*60;
    this.y+=this.vy*dt*60;

    const dx=this.x-center.x;
    const dy=this.y-center.y;
    const d=Math.hypot(dx,dy);

    if(d>globeRadius-1){
      const nx=dx/d, ny=dy/d;
      this.x=center.x+nx*(globeRadius-1);
      this.y=center.y+ny*(globeRadius-1);

      const dot=this.vx*nx+this.vy*ny;
      this.vx -= 1.6*dot*nx;
      this.vy -= 1.6*dot*ny;

      this.vx*=0.9; this.vy*=0.9;
    }
  }
  draw(){
    ctx.globalAlpha=this.alpha;
    ctx.beginPath();
    ctx.arc(this.x,this.y,this.size,0,Math.PI*2);
    ctx.fillStyle="#fff";
    ctx.fill();
    ctx.globalAlpha=1;
  }
}


// ---------------- SNOW OBJECT (circular physics) ----------------
class SnowObj{
  constructor(img){
    this.img=img;
    this.scale=0.25*(Math.min(W,H)/500);
    this.w=img.width*this.scale;
    this.h=img.height*this.scale;
    this.r=Math.max(this.w,this.h)*0.45;

    this.x=center.x;
    this.y=center.y - globeRadius*0.4;
    this.vx=0; this.vy=0;

    this.angle=0;
    this.angularVelocity=0;  // IMPORTANT: zero at start
  }

  applyForce(fx,fy){
    this.vx+=fx;
    this.vy+=fy;
    this.angularVelocity += (Math.random()-.5)*0.02;
  }

  update(dt){
    this.vy += OBJ_GRAVITY*dt*60;
    this.x += this.vx*dt*60;
    this.y += this.vy*dt*60;

    // ROTATION FIX: zero small drift
    this.angle += this.angularVelocity*dt*60;

    if(Math.abs(this.angularVelocity) < 0.0008){
      this.angularVelocity = 0;   // <--- stops perpetual rotation
    }

    this.vx *= OBJ_DAMP;
    this.vy *= OBJ_DAMP;
    this.angularVelocity *= 0.98;

    // Boundary collision
    const dx=this.x-center.x;
    const dy=this.y-center.y;
    const d=Math.hypot(dx,dy);
    const maxD=globeRadius - this.r;

    if(d>maxD){
      const nx=dx/d, ny=dy/d;
      const overlap=d-maxD;

      this.x-=nx*overlap*0.5;
      this.y-=ny*overlap*0.5;

      const dot=this.vx*nx+this.vy*ny;
      this.vx -= (1.0+0.35)*dot*nx;
      this.vy -= (1.0+0.35)*dot*ny;

      // sliding
      const tx=-ny, ty=nx;
      const tdot=this.vx*tx+this.vy*ty;
      this.vx = (this.vx - tdot*tx)*0.9 + tdot*tx;
      this.vy = (this.vy - tdot*ty)*0.9 + tdot*ty;

      this.angularVelocity += (Math.sign(tdot)||1)*0.01;  
    }
  }

  draw(){
    ctx.save();
    ctx.translate(this.x,this.y);
    ctx.rotate(this.angle);
    ctx.drawImage(this.img,-this.w/2,-this.h/2,this.w,this.h);
    ctx.restore();
  }
}


// ---------------- INIT ----------------
let particles=[];
let obj=null;
let last=performance.now();

function start(){
  for(let i=0;i<PARTICLE_COUNT;i++) particles.push(new Particle());
  obj=new SnowObj(objImg);
  requestAnimationFrame(loop);
}

bgImg.onload = ()=>{ if(objImg.complete) start(); };
objImg.onload = ()=>{ if(bgImg.complete) start(); };


// ---------------- MAIN LOOP ----------------
function loop(time){
  const dt=Math.min(.033,(time-last)/1000);
  last=time;

  ctx.clearRect(0,0,W,H);

  // Clip to globe
  ctx.save();
  ctx.beginPath();
  ctx.arc(center.x,center.y,globeRadius,0,Math.PI*2);
  ctx.clip();

  // Background
  if(bgImg.complete){
    ctx.drawImage(bgImg,0,0,W,H);
  }

  // Snow object
  obj.update(dt);
  obj.draw();

  // Particles
  for(const p of particles){ p.update(dt); p.draw(); }

  // --- SUBTLE GLASS GLARE OVERLAY ---
  ctx.save();
  ctx.globalAlpha = 0.22;
  const g = ctx.createRadialGradient(
    center.x - globeRadius*0.4, center.y - globeRadius*0.5, 5,
    center.x, center.y, globeRadius*1.1
  );
  g.addColorStop(0, "rgba(255,255,255,0.55)");
  g.addColorStop(1, "rgba(255,255,255,0.0)");
  ctx.fillStyle=g;
  ctx.beginPath();
  ctx.arc(center.x,center.y,globeRadius,0,Math.PI*2);
  ctx.fill();
  ctx.restore();

  // Top highlight arc
  ctx.save();
  ctx.globalAlpha=0.14;
  const lg=ctx.createLinearGradient(0,0,0,globeRadius*0.4);
  lg.addColorStop(0,"rgba(255,255,255,0.32)");
  lg.addColorStop(1,"rgba(255,255,255,0)");
  ctx.fillStyle=lg;
  ctx.beginPath();
  ctx.arc(center.x,center.y,globeRadius,Math.PI*1.08,Math.PI*1.92);
  ctx.fill();
  ctx.restore();

  ctx.restore();

  requestAnimationFrame(loop);
}

</script>
</body>
</html>
